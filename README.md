# Consul介绍

**Consul**是HashiCorp公司推出的开源工具，用于实现分布式系统的服务发现与配置。 与其他分布式服务注册与发现的方案，**Consul**的方案更"一站式"，内置了服务注册与发现框架、分布一致性协议实现、健康检查、Key/Value存储、多数据中心方案，不再需要依赖其他工具。

# CITA NG的问题

都是微服务化之后的一些常规问题。

比如服务发现，如何把本服务的`ip`和`port`告诉其他微服务，如何获取其他微服务的`ip`和`port`。

比如配置，如何做到可以动态修改配置，并自动生效。

比如启动顺序，如何等自己依赖的服务起来之后，再启动本服务，避免代码中出现过多异常处理的代码。

# 解决方案

使用`consul`加`consul-template`可以解决目前遇到的问题。

其实目前的方案只用到这两个工具很小一部分功能，更多功能还有待进一步摸索。

对微服务来说，最简单最轻松的方式是静态的配置文件。因此将微服务的`ip`和`port`以及相关配置项都注册到`consul`，然后通过`consul-template`生成配置文件。

动态配置方面，`consul-template`可以在相关配置发生变更的时候，自动更新配置文件，同时可以执行一条命令。可以将这条命令设置为杀掉原有服务，因为`consul-template`会自动重启服务，从而实现配置变更自动生效的效果。但是服务因为其他原因异常退出的时候，`consul-template`并不会重启服务。

当多个节点跑在一个服务器上时，杀掉原有服务的命令会误把其他节点的服务也杀掉。后续可以通过`pid`文件的方式来解决。

启动顺序方面，经过测试，如果本微服务的配置文件依赖两个配置项，那么在两个配置项都被注册到`consul`之前，`consul-template`不会生成配置文件，也不会启动相应的微服务。因为微服务间的依赖，大部分也都可以体现为配置项的依赖。因此可以通过这种方式来解决启动顺序的问题。

# 配置项列表

### 全局配置

##### 日志

包括日志等级和日志的`appenders`。每个微服务一个日志配置文件的模板。`global.log4rs.level`和`global.log4rs.appenders`。

##### 环境变量

微服务的名字用环境变量(`SERVICE_NAME`)。这样就可以只使用一个日志模板了。

节点名字类似`node0`，这个也设置为环境变量(`NODE_NAME`)。这样会在多个节点使用一个`consul`实例时，比如四个节点跑在一台服务器上时，作为`key prefix`来区分不同的节点相同的`key`。作用类似于`rabbitmq`的`vhost`。

### 微服务配置

##### 网络

注册网络模块的端口，`key`为`network_port`。





